# Data Model: ShopTalk

**Feature**: ShopTalk AI Assistant | **Date**: 2025-02-08

Entities and validation rules derived from [requirements.md](requirements.md) and [architecture.md](architecture.md).

---

## 1. Product (ABO / Vector Store)

Represents an item in the catalog; stored in ChromaDB/OpenSearch with metadata and optional image caption.

### ABO Source Format (from EDA notebook)

> The ABO dataset stores metadata as **JSON Lines** (`.json.gz`), NOT CSV. Many fields use a **nested `[{language_tag, value}]` format** (e.g., `item_name`, `brand`, `bullet_point`, `product_description`, `item_keywords`). The ingestion pipeline must flatten these to English values. See `extract_lang_value()` / `extract_list_values()` in `notebooks/01_shoptalk_eda.ipynb`.

### Product Entity (Flattened for App Use)

| Field | Type | Validation | ABO Source Field | Notes |
|-------|------|------------|-----------------|--------|
| id | string | required, unique | `item_id` | ABO product ID |
| title | string | required | `item_name` (flattened, en_US preferred) | Product title |
| description | string | optional | `product_description` (flattened) | Free-text description |
| bullet_points | string | optional | `bullet_point` (flattened, joined) | Key feature bullets |
| keywords | string | optional | `item_keywords` (flattened, joined) | Seller search keywords |
| brand | string | optional | `brand` (flattened) | Brand / manufacturer |
| color | string | optional | `color` (flattened) | Product color(s) |
| category | string | optional | `product_type[0].value` | Product type hierarchy (filter dimension) |
| price | decimal | optional, >= 0 | **NOT in ABO** | **Synthetic**: ABO has no price field; must be generated (e.g., random by category) or omitted. UI filter `price_max` only works if synthetic prices are assigned during ingestion. |
| image_caption | string | optional | *(generated by BLIP/CLIP)* | Appended to search text |
| image_url | string | optional | Derived from `main_image_id` + image base path | ABO stores image **IDs**, not URLs; path constructed during ingestion (e.g., `images/small/{id}.jpg`) |
| country | string | optional | `country` | Market / locale |
| embedding_id | string | optional | *(same as id)* | Vector store document ID |

**Relationships**: None (flat document). Used by hybrid search (semantic on description+title+bullet_points+caption+keywords; keyword/filter on price, category, brand, color).

**Lifecycle**: Ingested by pipeline (Airflow) from ABO JSON Lines → flattened → embedded → upserted to ChromaDB. Updated daily. No application-level state transitions.

### Data Format Notes (Post-EDA)

- **Multilingual data**: ABO has entries in multiple languages; ingestion must filter/prefer `en_US` or `en_*`.
- **Nested extraction**: Use `extract_lang_value(cell, "en_US")` for single-value fields; `extract_list_values(cell)` for multi-value fields (bullet_point, keywords).
- **No price**: This is a known ABO limitation. Options: (1) assign synthetic prices by category for demo/filter purposes, (2) remove price_max filter, or (3) use a supplementary dataset with prices. **Decision required during T042 (ingestion).**

---

## 2. Chat Message (In-Memory Only)

A single message in the session chat. Not persisted except optional export for 50 qualitative responses.

| Field | Type | Validation | Notes |
|-------|------|------------|--------|
| role | enum | "user" \| "assistant" \| "system" | Who sent the message |
| content | string | required | Text (user query or assistant response) |
| timestamp | datetime | optional | Client or server time |
| message_type | enum | "text" \| "status" \| "error" | status = "Listening…" etc.; error = STT/RAG/TTS failure |
| product_ids | list[string] | optional | For assistant: product IDs referenced in this turn (for product cards) |

**Relationships**: Part of a logical Session (no persisted session entity; identified by browser/session). Order by timestamp for context in RAG.

**Lifecycle**: Created when user speaks or assistant responds; discarded on tab close/refresh. Optional: anonymized export of last N assistant messages for evaluation (50-query set).

---

## 3. Voice Request / Response (API)

Payloads for the voice pipeline. Not stored; request/response only.

**VoiceQueryRequest** (e.g. from Streamlit to FastAPI):

| Field | Type | Validation |
|-------|------|------------|
| audio_base64 | string | optional | Recorded audio (e.g. base64 WAV) |
| session_id | string | optional | For session isolation (if multi-request) |
| filters | object | optional | { "price_max": number, "category": string } |

**VoiceQueryResponse**:

| Field | Type | Validation |
|-------|------|------------|
| transcript | string | optional | STT output (empty on STT failure) |
| response_text | string | required | Assistant reply (or error message) |
| product_ids | list[string] | optional | Top-K product IDs for product cards |
| status | string | optional | "ok" \| "stt_failed" \| "no_results" \| "pipeline_error" |
| audio_base64 | string | optional | TTS audio (optional; e.g. for empty/error, no TTS) |

---

## 4. Search Request / Result (Internal or API)

**SearchRequest** (keyword + semantic inputs):

| Field | Type | Validation |
|-------|------|------------|
| query_text | string | required |
| top_k | int | optional, default 5, 1–20 |
| filters | object | optional | price range, category |
| session_context | list[ChatMessage] | optional | For "show me the blue one" style follow-ups |

**SearchResult**:

| Field | Type | Validation |
|-------|------|------------|
| product_ids | list[string] | Ordered by relevance |
| products | list[Product] | optional | Full product records for display |
| total | int | Count (0 for empty search) |

---

## 5. Evaluation Export (50-Query Set)

For qualitative scoring only; stored only when explicitly exporting.

| Field | Type | Validation |
|-------|------|------------|
| query_id | string | optional, unique per export |
| query_text | string | Anonymized user query text |
| response_text | string | Assistant response |
| product_ids | list[string] | Retrieved product IDs |
| scores | object | optional | Helpfulness, Naturalness (filled later) |

**Retention**: Anonymized transcripts for 50 query responses only; no voice recordings; no general chat persistence.

---

## 6. Identity and Uniqueness

- **Product.id**: Unique per ABO dataset; primary key in vector store.
- **Chat messages**: No persistent ID; in-memory list keyed by session.
- **Session**: No stored entity; identified by Streamlit session_id or browser cookie/lifetime.

---

## 7. State Transitions

- **Product**: Ingested → Indexed (in vector store). No app-level states.
- **Chat**: Message appended to in-memory list; no state machine.
- **Voice pipeline**: Recording → Transcribing → Searching → Generating → Speaking; any step can transition to error state (response_text = error message, status = stt_failed | no_results | pipeline_error).
